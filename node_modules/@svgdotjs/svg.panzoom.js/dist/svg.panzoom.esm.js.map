{"version":3,"file":"svg.panzoom.esm.js","sources":["../src/svg.panzoom.js"],"sourcesContent":["import { Svg, on, off, extend, Matrix, Box } from '@svgdotjs/svg.js'\n\nconst normalizeEvent = ev =>\n  ev.touches || [{ clientX: ev.clientX, clientY: ev.clientY }]\n\nextend(Svg, {\n  panZoom (options) {\n    this.off('.panZoom')\n\n    // when called with false, disable panZoom\n    if (options === false) return this\n\n    options = options ?? {}\n    const zoomFactor = options.zoomFactor ?? 2\n    const zoomMin = options.zoomMin ?? Number.MIN_VALUE\n    const zoomMax = options.zoomMax ?? Number.MAX_VALUE\n    const doWheelZoom = options.wheelZoom ?? true\n    const doPinchZoom = options.pinchZoom ?? true\n    const doPanning = options.panning ?? true\n    const panButton = options.panButton ?? 0\n    const oneFingerPan = options.oneFingerPan ?? false\n    const margins = options.margins ?? false\n    const wheelZoomDeltaModeLinePixels = options.wheelZoomDeltaModeLinePixels ?? 17\n    const wheelZoomDeltaModeScreenPixels = options.wheelZoomDeltaModeScreenPixels ?? 53\n\n    let lastP\n    let lastTouches\n    let zoomInProgress = false\n\n    const viewbox = this.viewbox()\n\n    const restrictToMargins = box => {\n      if (!margins) return box\n      const { top, left, bottom, right } = margins\n\n      const { width, height } = this.attr(['width', 'height'])\n      const preserveAspectRatio = this.node.preserveAspectRatio.baseVal\n\n      // The current viewport (exactly what is shown on the screen, what we ultimately want to restrict)\n      // is not always exactly the same as current viewbox. They are different when the viewbox aspectRatio and the svg aspectRatio\n      // are different and preserveAspectRatio is not \"none\". These offsets represent the difference in user coordinates\n      // between the side of the viewbox and the side of the viewport.\n      let viewportLeftOffset = 0\n      let viewportRightOffset = 0\n      let viewportTopOffset = 0\n      let viewportBottomOffset = 0\n\n      // preserveAspectRatio none has no offsets\n      if (preserveAspectRatio.align !== preserveAspectRatio.SVG_PRESERVEASPECTRATIO_NONE) {\n        const svgAspectRatio = width / height\n        const viewboxAspectRatio = viewbox.width / viewbox.height\n        // when aspectRatios are the same, there are no offsets\n        if (viewboxAspectRatio !== svgAspectRatio) {\n          // aspectRatio unknown is like meet because that's the default\n          const isMeet = preserveAspectRatio.meetOrSlice !== preserveAspectRatio.SVG_MEETORSLICE_SLICE\n          const changedAxis = svgAspectRatio > viewboxAspectRatio ? 'width' : 'height'\n          const isWidth = changedAxis === 'width'\n          const changeHorizontal = (isMeet && isWidth) || (!isMeet && !isWidth)\n          const ratio = changeHorizontal\n            ? svgAspectRatio / viewboxAspectRatio\n            : viewboxAspectRatio / svgAspectRatio\n\n          const offset = box[changedAxis] - box[changedAxis] * ratio\n          if (changeHorizontal) {\n            if (\n              preserveAspectRatio.align === preserveAspectRatio.SVG_PRESERVEASPECTRATIO_XMIDYMIN ||\n              preserveAspectRatio.align === preserveAspectRatio.SVG_PRESERVEASPECTRATIO_XMIDYMID ||\n              preserveAspectRatio.align === preserveAspectRatio.SVG_PRESERVEASPECTRATIO_XMIDYMAX) {\n              viewportLeftOffset = offset / 2\n              viewportRightOffset = -offset / 2\n            } else if (\n              preserveAspectRatio.align === preserveAspectRatio.SVG_PRESERVEASPECTRATIO_XMINYMIN ||\n              preserveAspectRatio.align === preserveAspectRatio.SVG_PRESERVEASPECTRATIO_XMINYMID ||\n              preserveAspectRatio.align === preserveAspectRatio.SVG_PRESERVEASPECTRATIO_XMINYMAX) {\n              viewportRightOffset = -offset\n            } else if (\n              preserveAspectRatio.align === preserveAspectRatio.SVG_PRESERVEASPECTRATIO_XMAXYMIN ||\n              preserveAspectRatio.align === preserveAspectRatio.SVG_PRESERVEASPECTRATIO_XMAXYMID ||\n              preserveAspectRatio.align === preserveAspectRatio.SVG_PRESERVEASPECTRATIO_XMAXYMAX) {\n              viewportLeftOffset = offset\n            }\n          } else {\n            if (\n              preserveAspectRatio.align === preserveAspectRatio.SVG_PRESERVEASPECTRATIO_XMINYMID ||\n              preserveAspectRatio.align === preserveAspectRatio.SVG_PRESERVEASPECTRATIO_XMIDYMID ||\n              preserveAspectRatio.align === preserveAspectRatio.SVG_PRESERVEASPECTRATIO_XMAXYMID) {\n              viewportTopOffset = offset / 2\n              viewportBottomOffset = -offset / 2\n            } else if (\n              preserveAspectRatio.align === preserveAspectRatio.SVG_PRESERVEASPECTRATIO_XMINYMIN ||\n              preserveAspectRatio.align === preserveAspectRatio.SVG_PRESERVEASPECTRATIO_XMIDYMIN ||\n              preserveAspectRatio.align === preserveAspectRatio.SVG_PRESERVEASPECTRATIO_XMAXYMIN) {\n              viewportBottomOffset = -offset\n            } else if (\n              preserveAspectRatio.align === preserveAspectRatio.SVG_PRESERVEASPECTRATIO_XMINYMAX ||\n              preserveAspectRatio.align === preserveAspectRatio.SVG_PRESERVEASPECTRATIO_XMIDYMAX ||\n              preserveAspectRatio.align === preserveAspectRatio.SVG_PRESERVEASPECTRATIO_XMAXYMAX) {\n              viewportTopOffset = offset\n            }\n          }\n\n        }\n      }\n\n      // when box.x == leftLimit, the image is panned to the left,\n      // i.e the current box is to the right of the initial viewbox,\n      // and only the right part of the initial image is visible, i.e.\n      // the right side of the initial viewbox minus left margin (viewbox.x+viewbox.width-left)\n      // is aligned with the left side of the viewport (box.x + viewportLeftOffset):\n      // viewbox.width + viewbox.x - left = box.x + viewportLeftOffset\n      // viewbox.width + viewbox.x - left - viewportLeftOffset = box.x (= leftLimit)\n      const leftLimit = viewbox.width + viewbox.x - left - viewportLeftOffset\n      // when box.x == rightLimit, the image is panned to the right,\n      // i.e the current box is to the left of the initial viewbox\n      // and only the left part of the initial image is visible, i.e\n      // the left side of the initial viewbox plus right margin (viewbox.x + right)\n      // is aligned with the right side of the viewport (box.x + box.width + viewportRightOffset)\n      // viewbox.x + right = box.x + box.width + viewportRightOffset\n      // viewbox.x + right - box.width - viewportRightOffset = box.x (= rightLimit)\n      const rightLimit = viewbox.x + right - box.width - viewportRightOffset\n      // same with top and bottom\n      const topLimit = viewbox.height + viewbox.y - top - viewportTopOffset\n      const bottomLimit = viewbox.y + bottom - box.height - viewportBottomOffset\n\n      box.x = Math.min(leftLimit, Math.max(rightLimit, box.x)) // enforce rightLimit <= box.x <= leftLimit\n      box.y = Math.min(topLimit, Math.max(bottomLimit, box.y)) // enforce bottomLimit <= box.y <= topLimit\n      return box\n    }\n\n    const wheelZoom = function (ev) {\n      ev.preventDefault()\n\n      // When wheeling on a mouse,\n      // - chrome by default uses deltaY = 53, deltaMode = 0 (pixel)\n      // - firefox by default uses deltaY = 3, deltaMode = 1 (line)\n      // - chrome and firefox on windows after configuring \"One screen at a time\"\n      //   use deltaY = 1, deltaMode = 2 (screen)\n      //\n      // Note that when when wheeling on a touchpad, deltaY depends on how fast\n      // you swipe, but the deltaMode is still different between the browsers.\n      //\n      // Normalize everything so that zooming speed is approximately the same in all cases\n      let normalizedPixelDeltaY\n      switch (ev.deltaMode) {\n      case 1:\n        normalizedPixelDeltaY = ev.deltaY * wheelZoomDeltaModeLinePixels\n        break\n      case 2:\n        normalizedPixelDeltaY = ev.deltaY * wheelZoomDeltaModeScreenPixels\n        break\n      default:\n        // 0 (already pixels) or new mode (avoid crashing)\n        normalizedPixelDeltaY = ev.deltaY\n        break\n      }\n\n      let lvl = Math.pow(1 + zoomFactor, (-1 * normalizedPixelDeltaY) / 100) * this.zoom()\n      const p = this.point(ev.clientX, ev.clientY)\n\n      if (lvl > zoomMax) {\n        lvl = zoomMax\n      }\n\n      if (lvl < zoomMin) {\n        lvl = zoomMin\n      }\n\n      if (this.dispatch('zoom', { level: lvl, focus: p }).defaultPrevented) {\n        return this\n      }\n\n      this.zoom(lvl, p)\n\n      if (margins) {\n        const box = restrictToMargins(this.viewbox())\n        this.viewbox(box)\n      }\n    }\n\n    const pinchZoomStart = function (ev) {\n      lastTouches = normalizeEvent(ev)\n\n      // Start panning in case only one touch is found\n      if (lastTouches.length < 2) {\n        if (doPanning && oneFingerPan) {\n          panStart.call(this, ev)\n        }\n        return\n      }\n\n      // Stop panning for more than one touch\n      if (doPanning && oneFingerPan) {\n        panStop.call(this, ev)\n      }\n\n      // We call it so late, so the user is still able to scroll / reload the page via gesture\n      // In case oneFingerPan is not active\n      ev.preventDefault()\n\n      if (this.dispatch('pinchZoomStart', { event: ev }).defaultPrevented) {\n        return\n      }\n\n      this.off('touchstart.panZoom', pinchZoomStart)\n\n      zoomInProgress = true\n      on(document, 'touchmove.panZoom', pinchZoom, this, { passive: false })\n      on(document, 'touchend.panZoom', pinchZoomStop, this, { passive: false })\n    }\n\n    const pinchZoomStop = function (ev) {\n      ev.preventDefault()\n\n      const currentTouches = normalizeEvent(ev)\n      if (currentTouches.length > 1) {\n        return\n      }\n\n      zoomInProgress = false\n\n      this.dispatch('pinchZoomEnd', { event: ev })\n\n      off(document, 'touchmove.panZoom', pinchZoom)\n      off(document, 'touchend.panZoom', pinchZoomStop)\n      this.on('touchstart.panZoom', pinchZoomStart)\n\n      if (currentTouches.length && doPanning && oneFingerPan) {\n        panStart.call(this, ev)\n      }\n    }\n\n    const pinchZoom = function (ev) {\n      ev.preventDefault()\n\n      const currentTouches = normalizeEvent(ev)\n      const zoom = this.zoom()\n\n      // Distance Formula\n      const lastDelta = Math.sqrt(\n        Math.pow(lastTouches[0].clientX - lastTouches[1].clientX, 2) +\n          Math.pow(lastTouches[0].clientY - lastTouches[1].clientY, 2)\n      )\n\n      const currentDelta = Math.sqrt(\n        Math.pow(currentTouches[0].clientX - currentTouches[1].clientX, 2) +\n          Math.pow(currentTouches[0].clientY - currentTouches[1].clientY, 2)\n      )\n\n      let zoomAmount = lastDelta / currentDelta\n\n      if (\n        (zoom < zoomMin && zoomAmount > 1) ||\n        (zoom > zoomMax && zoomAmount < 1)\n      ) {\n        zoomAmount = 1\n      }\n\n      const currentFocus = {\n        x:\n          currentTouches[0].clientX +\n          0.5 * (currentTouches[1].clientX - currentTouches[0].clientX),\n        y:\n          currentTouches[0].clientY +\n          0.5 * (currentTouches[1].clientY - currentTouches[0].clientY)\n      }\n\n      const lastFocus = {\n        x:\n          lastTouches[0].clientX +\n          0.5 * (lastTouches[1].clientX - lastTouches[0].clientX),\n        y:\n          lastTouches[0].clientY +\n          0.5 * (lastTouches[1].clientY - lastTouches[0].clientY)\n      }\n\n      const p = this.point(currentFocus.x, currentFocus.y)\n      const focusP = this.point(\n        2 * currentFocus.x - lastFocus.x,\n        2 * currentFocus.y - lastFocus.y\n      )\n      const box = new Box(this.viewbox()).transform(\n        new Matrix()\n          .translate(-focusP.x, -focusP.y)\n          .scale(zoomAmount, 0, 0)\n          .translate(p.x, p.y)\n      )\n\n      restrictToMargins(box)\n      this.viewbox(box)\n\n      lastTouches = currentTouches\n\n      this.dispatch('zoom', { box: box, focus: focusP })\n    }\n\n    const panStart = function (ev) {\n      const isMouse = ev.type.indexOf('mouse') > -1\n\n      // In case panStart is called with touch, ev.button is undefined\n      if (isMouse && ev.button !== panButton && ev.which !== panButton + 1) {\n        return\n      }\n\n      ev.preventDefault()\n\n      this.off('mousedown.panZoom', panStart)\n\n      lastTouches = normalizeEvent(ev)\n\n      if (zoomInProgress) return\n\n      this.dispatch('panStart', { event: ev })\n\n      lastP = { x: lastTouches[0].clientX, y: lastTouches[0].clientY }\n\n      on(document, 'touchmove.panZoom mousemove.panZoom', panning, this, {\n        passive: false\n      })\n\n      on(document, 'touchend.panZoom mouseup.panZoom', panStop, this, {\n        passive: false\n      })\n    }\n\n    const panStop = function (ev) {\n      ev.preventDefault()\n\n      off(document, 'touchmove.panZoom mousemove.panZoom', panning)\n      off(document, 'touchend.panZoom mouseup.panZoom', panStop)\n      this.on('mousedown.panZoom', panStart)\n\n      this.dispatch('panEnd', { event: ev })\n    }\n\n    const panning = function (ev) {\n      ev.preventDefault()\n\n      const currentTouches = normalizeEvent(ev)\n\n      const currentP = {\n        x: currentTouches[0].clientX,\n        y: currentTouches[0].clientY\n      }\n\n      const p1 = this.point(currentP.x, currentP.y)\n\n      const p2 = this.point(lastP.x, lastP.y)\n\n      const deltaP = [p2.x - p1.x, p2.y - p1.y]\n\n      if (!deltaP[0] && !deltaP[1]) {\n        return\n      }\n\n      const box = new Box(this.viewbox()).transform(\n        new Matrix().translate(deltaP[0], deltaP[1])\n      )\n\n      lastP = currentP\n\n      restrictToMargins(box)\n\n      if (this.dispatch('panning', { box, event: ev }).defaultPrevented) {\n        return\n      }\n\n      this.viewbox(box)\n    }\n\n    if (doWheelZoom) {\n      this.on('wheel.panZoom', wheelZoom, this, { passive: false })\n    }\n\n    if (doPinchZoom) {\n      this.on('touchstart.panZoom', pinchZoomStart, this, { passive: false })\n    }\n\n    if (doPanning) {\n      this.on('mousedown.panZoom', panStart, this, { passive: false })\n    }\n\n    return this\n  }\n})\n"],"names":["normalizeEvent","ev","touches","clientX","clientY","extend","Svg","panZoom","options","off","zoomFactor","zoomMin","Number","MIN_VALUE","zoomMax","MAX_VALUE","doWheelZoom","wheelZoom","doPinchZoom","pinchZoom","doPanning","panning","panButton","oneFingerPan","margins","wheelZoomDeltaModeLinePixels","wheelZoomDeltaModeScreenPixels","lastP","lastTouches","zoomInProgress","viewbox","restrictToMargins","box","top","left","bottom","right","attr","width","height","preserveAspectRatio","node","baseVal","viewportLeftOffset","viewportRightOffset","viewportTopOffset","viewportBottomOffset","align","SVG_PRESERVEASPECTRATIO_NONE","svgAspectRatio","viewboxAspectRatio","isMeet","meetOrSlice","SVG_MEETORSLICE_SLICE","changedAxis","isWidth","changeHorizontal","ratio","offset","SVG_PRESERVEASPECTRATIO_XMIDYMIN","SVG_PRESERVEASPECTRATIO_XMIDYMID","SVG_PRESERVEASPECTRATIO_XMIDYMAX","SVG_PRESERVEASPECTRATIO_XMINYMIN","SVG_PRESERVEASPECTRATIO_XMINYMID","SVG_PRESERVEASPECTRATIO_XMINYMAX","SVG_PRESERVEASPECTRATIO_XMAXYMIN","SVG_PRESERVEASPECTRATIO_XMAXYMID","SVG_PRESERVEASPECTRATIO_XMAXYMAX","leftLimit","x","rightLimit","topLimit","y","bottomLimit","Math","min","max","preventDefault","normalizedPixelDeltaY","deltaMode","deltaY","lvl","pow","zoom","p","point","dispatch","level","focus","defaultPrevented","pinchZoomStart","length","panStart","call","panStop","event","on","document","passive","pinchZoomStop","currentTouches","lastDelta","sqrt","currentDelta","zoomAmount","currentFocus","lastFocus","focusP","Box","transform","Matrix","translate","scale","isMouse","type","indexOf","button","which","currentP","p1","p2","deltaP"],"mappings":"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"}